<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdVenture Capitalist</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; }
        .progress-bar-inner { transition: width 0.1s linear; }
        .cash-display { font-weight: 900; font-family: monospace; min-height: 1.5em; white-space: nowrap; }
        .tab-btn.active { border-bottom-width: 2px; border-color: #f59e0b; color: #f59e0b; }
        button:disabled { cursor: not-allowed; }
        @keyframes pulse-startup {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }
        .pulse-startup { animation: pulse-startup 1.5s infinite; }

        /* --- [NEW] Skill Tree Styles --- */
        .upgrade-track {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-grow: 1;
            margin-left: 1rem;
            padding: 0 1rem;
        }
        /* The connecting line */
        .upgrade-track::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 1rem;
            right: 1rem;
            height: 2px;
            background-color: #4b5563; /* gray-600 */
            transform: translateY(-50%);
            z-index: 0;
        }
        .upgrade-node {
            position: relative;
            z-index: 1;
            width: 120px;
            height: 100px;
            border-width: 2px;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        /* State: Locked */
        .upgrade-node.locked {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
            color: #9ca3af; /* gray-400 */
            filter: grayscale(50%);
        }
        /* State: Unlocked (can't afford) */
        .upgrade-node.unlocked {
            background-color: #1f2937; /* gray-800 */
            border-color: #f59e0b; /* amber-500 */
            color: #d1d5db; /* gray-300 */
        }
        /* State: Unlocked (can afford) */
        .upgrade-node.unlocked:not(:disabled) {
            cursor: pointer;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .upgrade-node.unlocked:not(:disabled):hover {
            transform: scale(1.05);
            border-color: #fbbf24; /* amber-400 */
        }
        /* State: Purchased */
        .upgrade-node.purchased {
            background-color: #166534; /* green-800 */
            border-color: #22c55e; /* green-500 */
            color: #d1d5db; /* gray-300 */
        }
        .upgrade-node .effect { font-weight: 700; font-size: 0.875rem; color: white; }
        .upgrade-node .cost { color: #86efac; /* green-300 */ }
        .upgrade-node .req { font-size: 0.65rem; }
        .upgrade-node.purchased .effect::before {
            content: '‚úî ';
            color: #86efac; /* green-300 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-amber-500"></div>
        <p class="mt-4 text-lg font-semibold">Loading Game Data...</p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-10 bg-gray-800 shadow-md p-3 grid grid-cols-2 gap-4">
        <div>
            <span class="text-sm text-green-400">Cash</span>
            <div id="cash-display" class="cash-display text-xl md:text-3xl text-green-300">$0,00</div>
        </div>
        <div class="text-right">
            <span class="text-sm text-blue-400">Angel Investors</span>
            <div id="angels-display" class="cash-display text-xl md:text-3xl text-blue-300">0</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 max-w-5xl">
        
        <!-- Tab Navigation -->
        <nav class="flex justify-center space-x-4 md:space-x-8 mb-4 border-b border-gray-700">
            <button id="tab-btn-businesses" class="tab-btn active py-2 px-4 font-semibold text-gray-400" onclick="showTab('businesses')">Businesses</button>
            <button id="tab-btn-upgrades" class="tab-btn py-2 px-4 font-semibold text-gray-400" onclick="showTab('upgrades')">Upgrades</button>
            <button id="tab-btn-angels" class="tab-btn py-2 px-4 font-semibold text-gray-400" onclick="showTab('angels')">Angel Investors</button>
        </nav>

        <!-- Buy Amount Toggle -->
        <div class="flex justify-center rounded-lg shadow-sm bg-gray-700 w-fit mx-auto mb-4" role="group">
            <button type="button" class="buy-toggle-btn active bg-amber-500" onclick="setBuyAmount(1, this)">Buy 1</button>
            <button type="button" class="buy-toggle-btn" onclick="setBuyAmount(10, this)">Buy 10</button>
            <button type="button" class="buy-toggle-btn" onclick="setBuyAmount(100, this)">Buy 100</button>
            <button type="button" class="buy-toggle-btn" onclick="setBuyAmount('MAX', this)">Buy MAX</button>
        </div>
        <style>.buy-toggle-btn { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; color: white; background-color: transparent; border: 1px solid transparent; } .buy-toggle-btn:first-child { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; } .buy-toggle-btn:last-child { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; } .buy-toggle-btn:hover { background-color: #4b5563; } .buy-toggle-btn.active { background-color: #f59e0b; font-weight: 700; }</style>

        <!-- Tab Content Panels -->
        <div id="tab-content">
            
            <!-- Businesses Panel -->
            <div id="panel-businesses" class="tab-panel space-y-3">
                <!-- Business items will be injected here by JavaScript -->
            </div>

            <!-- Upgrades Panel -->
            <div id="panel-upgrades" class="tab-panel hidden">
                <div class="bg-gray-800 rounded-lg p-4 space-y-4">
                    <!-- [NEW] Static HTML Skill Tree -->
                    <!-- Lemonade -->
                    <div class="flex items-center">
                        <div class="text-4xl">üçã</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-lemonade-1" class="upgrade-node locked" onclick="buyUpgrade('lemonade-1')"><span class="effect">Profit x3</span><span class="cost">$1K</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-lemonade-2" class="upgrade-node locked" onclick="buyUpgrade('lemonade-2')"><span class="effect">Profit x3</span><span class="cost">$50K</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-lemonade-3" class="upgrade-node locked" onclick="buyUpgrade('lemonade-3')"><span class="effect">Speed x2</span><span class="cost">$200K</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Newspaper -->
                    <div class="flex items-center">
                        <div class="text-4xl">üì∞</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-newspaper-1" class="upgrade-node locked" onclick="buyUpgrade('newspaper-1')"><span class="effect">Profit x3</span><span class="cost">$60K</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-newspaper-2" class="upgrade-node locked" onclick="buyUpgrade('newspaper-2')"><span class="effect">Profit x4</span><span class="cost">$5M</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-newspaper-3" class="upgrade-node locked" onclick="buyUpgrade('newspaper-3')"><span class="effect">Speed x2</span><span class="cost">$50M</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Car Wash -->
                    <div class="flex items-center">
                        <div class="text-4xl">üöó</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-carwash-1" class="upgrade-node locked" onclick="buyUpgrade('carwash-1')"><span class="effect">Profit x3</span><span class="cost">$750K</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-carwash-2" class="upgrade-node locked" onclick="buyUpgrade('carwash-2')"><span class="effect">Profit x4</span><span class="cost">$80M</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-carwash-3" class="upgrade-node locked" onclick="buyUpgrade('carwash-3')"><span class="effect">Speed x2</span><span class="cost">$900M</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Pizza -->
                    <div class="flex items-center">
                        <div class="text-4xl">üçï</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-pizza-1" class="upgrade-node locked" onclick="buyUpgrade('pizza-1')"><span class="effect">Profit x3</span><span class="cost">$10M</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-pizza-2" class="upgrade-node locked" onclick="buyUpgrade('pizza-2')"><span class="effect">Profit x4</span><span class="cost">$1.2B</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-pizza-3" class="upgrade-node locked" onclick="buyUpgrade('pizza-3')"><span class="effect">Speed x2</span><span class="cost">$10B</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Donut -->
                    <div class="flex items-center">
                        <div class="text-4xl">üç©</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-donut-1" class="upgrade-node locked" onclick="buyUpgrade('donut-1')"><span class="effect">Profit x3</span><span class="cost">$120M</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-donut-2" class="upgrade-node locked" onclick="buyUpgrade('donut-2')"><span class="effect">Profit x4</span><span class="cost">$15B</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-donut-3" class="upgrade-node locked" onclick="buyUpgrade('donut-3')"><span class="effect">Speed x2</span><span class="cost">$180B</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Shrimp -->
                    <div class="flex items-center">
                        <div class="text-4xl">üç§</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-shrimp-1" class="upgrade-node locked" onclick="buyUpgrade('shrimp-1')"><span class="effect">Profit x3</span><span class="cost">$1.5B</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-shrimp-2" class="upgrade-node locked" onclick="buyUpgrade('shrimp-2')"><span class="effect">Profit x4</span><span class="cost">$180B</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-shrimp-3" class="upgrade-node locked" onclick="buyUpgrade('shrimp-3')"><span class="effect">Speed x2</span><span class="cost">$2.1T</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Hockey -->
                    <div class="flex items-center">
                        <div class="text-4xl">üèí</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-hockey-1" class="upgrade-node locked" onclick="buyUpgrade('hockey-1')"><span class="effect">Profit x3</span><span class="cost">$18B</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-hockey-2" class="upgrade-node locked" onclick="buyUpgrade('hockey-2')"><span class="effect">Profit x4</span><span class="cost">$2.2T</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-hockey-3" class="upgrade-node locked" onclick="buyUpgrade('hockey-3')"><span class="effect">Speed x2</span><span class="cost">$26T</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Movie -->
                    <div class="flex items-center">
                        <div class="text-4xl">üé¨</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-movie-1" class="upgrade-node locked" onclick="buyUpgrade('movie-1')"><span class="effect">Profit x3</span><span class="cost">$215B</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-movie-2" class="upgrade-node locked" onclick="buyUpgrade('movie-2')"><span class="effect">Profit x4</span><span class="cost">$26T</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-movie-3" class="upgrade-node locked" onclick="buyUpgrade('movie-3')"><span class="effect">Speed x2</span><span class="cost">$310T</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Bank -->
                    <div class="flex items-center">
                        <div class="text-4xl">üè¶</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-bank-1" class="upgrade-node locked" onclick="buyUpgrade('bank-1')"><span class="effect">Profit x3</span><span class="cost">$2.6T</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-bank-2" class="upgrade-node locked" onclick="buyUpgrade('bank-2')"><span class="effect">Profit x4</span><span class="cost">$315T</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-bank-3" class="upgrade-node locked" onclick="buyUpgrade('bank-3')"><span class="effect">Speed x2</span><span class="cost">$3.7Qa</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                    <!-- Oil Rig -->
                    <div class="flex items-center">
                        <div class="text-4xl">üõ¢Ô∏è</div>
                        <div class="upgrade-track">
                            <button id="upg-btn-oil-1" class="upgrade-node locked" onclick="buyUpgrade('oil-1')"><span class="effect">Profit x3</span><span class="cost">$31T</span><span class="req">Req: 25</span></button>
                            <button id="upg-btn-oil-2" class="upgrade-node locked" onclick="buyUpgrade('oil-2')"><span class="effect">Profit x4</span><span class="cost">$3.8Qa</span><span class="req">Req: 75</span></button>
                            <button id="upg-btn-oil-3" class="upgrade-node locked" onclick="buyUpgrade('oil-3')"><span class="effect">Speed x2</span><span class="cost">$45Qa</span><span class="req">Req: 150</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Angel Investors Panel -->
            <div id="panel-angels" class="tab-panel hidden">
                <div class="bg-gray-800 rounded-lg p-4 text-center">
                    <h2 class="text-2xl font-bold mb-4">Angel Investors</h2>
                    <p class="text-lg text-gray-300 mb-2">Each Angel provides a <span class="font-bold text-blue-300">+2% profit boost</span> to all businesses, forever!</p>
                    <p class="text-lg text-gray-300 mb-4">Your current boost: <span id="angel-boost-display" class="font-bold text-blue-300">0%</span></p>
                    
                    <div class="bg-gray-700 rounded-lg p-6 my-6">
                        <p class="text-xl text-gray-200">Angels to gain on reset:</p>
                        <p id="angels-to-gain-display" class="text-5xl font-black text-amber-400 my-3">0</p>
                        <p class="text-gray-400">You need more lifetime earnings to gain angels.</p>
                    </div>

                    <button id="prestige-button" class="w-full max-w-md bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg" onclick="prestige()">
                        Reset for Angels
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Resetting will set all your businesses, cash, and upgrades to 0, but you will keep your Angel Investors.</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Game Logic Script -->
    <script>
        
        // --- GLOBAL CONFIG & STATE ---
        let isGameLoaded = false;
        let isSaving = false;
        const SAVE_KEY = 'adventureCapitalistGame';

        // Throttling variables
        let lastCashUpdateTime = 0;
        let lastTimerUpdateTime = 0;

        // Game state object
        let game;
        let globalUiCache = {};

        // UI Element cache
        const ui = {
            cashDisplay: document.getElementById('cash-display'),
            angelsDisplay: document.getElementById('angels-display'),
            businessesPanel: document.getElementById('panel-businesses'),
            upgradesContainer: document.getElementById('upgrades-container'),
            angelsToGainDisplay: document.getElementById('angels-to-gain-display'),
            angelBoostDisplay: document.getElementById('angel-boost-display'),
            prestigeButton: document.getElementById('prestige-button'),
            loadingOverlay: document.getElementById('loading-overlay'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabPanels: document.querySelectorAll('.tab-panel'),
            buyToggleBtns: document.querySelectorAll('.buy-toggle-btn')
        };
        
        // --- GAME DATA DEFINITIONS ---
        function getDefaultGameState() {
            return {
                cash: 0,
                lifetimeCash: 0,
                angels: 0,
                lastUpdateTime: new Date().getTime(),
                buyAmount: 1,
                businesses: [
                    { id: 'lemonade', name: 'Lemonade Stand', count: 0, baseCost: 4, costRate: 1.07, baseRevenue: 1, baseTime: 0.6, managerCost: 500, hasManager: false, automationProgress: 0 },
                    { id: 'newspaper', name: 'Newspaper Delivery', count: 0, baseCost: 60, costRate: 1.15, baseRevenue: 60, baseTime: 3, managerCost: 10000, hasManager: false, automationProgress: 0 },
                    { id: 'carwash', name: 'Car Wash', count: 0, baseCost: 720, costRate: 1.14, baseRevenue: 720, baseTime: 6, managerCost: 100000, hasManager: false, automationProgress: 0 },
                    { id: 'pizza', name: 'Pizza Shop', count: 0, baseCost: 8640, costRate: 1.13, baseRevenue: 8640, baseTime: 12, managerCost: 1200000, hasManager: false, automationProgress: 0 },
                    { id: 'donut', name: 'Donut Shop', count: 0, baseCost: 103680, costRate: 1.12, baseRevenue: 103680, baseTime: 24, managerCost: 14400000, hasManager: false, automationProgress: 0 },
                    { id: 'shrimp', name: 'Shrimp Boat', count: 0, baseCost: 1244160, costRate: 1.11, baseRevenue: 1244160, baseTime: 96, managerCost: 172800000, hasManager: false, automationProgress: 0 },
                    { id: 'hockey', name: 'Hockey Team', count: 0, baseCost: 14929920, costRate: 1.10, baseRevenue: 14929920, baseTime: 384, managerCost: 2100000000, hasManager: false, automationProgress: 0 },
                    { id: 'movie', name: 'Movie Studio', count: 0, baseCost: 179159040, costRate: 1.09, baseRevenue: 179159040, baseTime: 1536, managerCost: 25200000000, hasManager: false, automationProgress: 0 },
                    { id: 'bank', name: 'Bank', count: 0, baseCost: 2149908480, costRate: 1.08, baseRevenue: 2149908480, baseTime: 6144, managerCost: 300000000000, hasManager: false, automationProgress: 0 },
                    { id: 'oil', name: 'Oil Rig', count: 0, baseCost: 25798901760, costRate: 1.07, baseRevenue: 25798901760, baseTime: 36864, managerCost: 3600000000000, hasManager: false, automationProgress: 0 }
                ],
                // [NEW] Expanded upgrade list
                upgrades: {
                    'lemonade-1':  { id: 'lemonade-1',  target: 'lemonade',  effect: 'profit', multiplier: 3, cost: 1e3,       unlockCount: 25,  purchased: false },
                    'lemonade-2':  { id: 'lemonade-2',  target: 'lemonade',  effect: 'profit', multiplier: 3, cost: 50e3,      unlockCount: 75,  purchased: false },
                    'lemonade-3':  { id: 'lemonade-3',  target: 'lemonade',  effect: 'speed',  multiplier: 2, cost: 200e3,     unlockCount: 150, purchased: false },
                    'newspaper-1': { id: 'newspaper-1', target: 'newspaper', effect: 'profit', multiplier: 3, cost: 60e3,      unlockCount: 25,  purchased: false },
                    'newspaper-2': { id: 'newspaper-2', target: 'newspaper', effect: 'profit', multiplier: 4, cost: 5e6,       unlockCount: 75,  purchased: false },
                    'newspaper-3': { id: 'newspaper-3', target: 'newspaper', effect: 'speed',  multiplier: 2, cost: 50e6,      unlockCount: 150, purchased: false },
                    'carwash-1':   { id: 'carwash-1',   target: 'carwash',   effect: 'profit', multiplier: 3, cost: 750e3,     unlockCount: 25,  purchased: false },
                    'carwash-2':   { id: 'carwash-2',   target: 'carwash',   effect: 'profit', multiplier: 4, cost: 80e6,      unlockCount: 75,  purchased: false },
                    'carwash-3':   { id: 'carwash-3',   target: 'carwash',   effect: 'speed',  multiplier: 2, cost: 900e6,     unlockCount: 150, purchased: false },
                    'pizza-1':     { id: 'pizza-1',     target: 'pizza',     effect: 'profit', multiplier: 3, cost: 10e6,      unlockCount: 25,  purchased: false },
                    'pizza-2':     { id: 'pizza-2',     target: 'pizza',     effect: 'profit', multiplier: 4, cost: 1.2e9,     unlockCount: 75,  purchased: false },
                    'pizza-3':     { id: 'pizza-3',     target: 'pizza',     effect: 'speed',  multiplier: 2, cost: 10e9,      unlockCount: 150, purchased: false },
                    'donut-1':     { id: 'donut-1',     target: 'donut',     effect: 'profit', multiplier: 3, cost: 120e6,     unlockCount: 25,  purchased: false },
                    'donut-2':     { id: 'donut-2',     target: 'donut',     effect: 'profit', multiplier: 4, cost: 15e9,      unlockCount: 75,  purchased: false },
                    'donut-3':     { id: 'donut-3',     target: 'donut',     effect: 'speed',  multiplier: 2, cost: 180e9,     unlockCount: 150, purchased: false },
                    'shrimp-1':    { id: 'shrimp-1',    target: 'shrimp',    effect: 'profit', multiplier: 3, cost: 1.5e9,     unlockCount: 25,  purchased: false },
                    'shrimp-2':    { id: 'shrimp-2',    target: 'shrimp',    effect: 'profit', multiplier: 4, cost: 180e9,     unlockCount: 75,  purchased: false },
                    'shrimp-3':    { id: 'shrimp-3',    target: 'shrimp',    effect: 'speed',  multiplier: 2, cost: 2.1e12,    unlockCount: 150, purchased: false },
                    'hockey-1':    { id: 'hockey-1',    target: 'hockey',    effect: 'profit', multiplier: 3, cost: 18e9,      unlockCount: 25,  purchased: false },
                    'hockey-2':    { id: 'hockey-2',    target: 'hockey',    effect: 'profit', multiplier: 4, cost: 2.2e12,    unlockCount: 75,  purchased: false },
                    'hockey-3':    { id: 'hockey-3',    target: 'hockey',    effect: 'speed',  multiplier: 2, cost: 26e12,     unlockCount: 150, purchased: false },
                    'movie-1':     { id: 'movie-1',     target: 'movie',     effect: 'profit', multiplier: 3, cost: 215e9,     unlockCount: 25,  purchased: false },
                    'movie-2':     { id: 'movie-2',     target: 'movie',     effect: 'profit', multiplier: 4, cost: 26e12,     unlockCount: 75,  purchased: false },
                    'movie-3':     { id: 'movie-3',     target: 'movie',     effect: 'speed',  multiplier: 2, cost: 310e12,    unlockCount: 150, purchased: false },
                    'bank-1':      { id: 'bank-1',      target: 'bank',      effect: 'profit', multiplier: 3, cost: 2.6e12,    unlockCount: 25,  purchased: false },
                    'bank-2':      { id: 'bank-2',      target: 'bank',      effect: 'profit', multiplier: 4, cost: 315e12,    unlockCount: 75,  purchased: false },
                    'bank-3':      { id: 'bank-3',      target: 'bank',      effect: 'speed',  multiplier: 2, cost: 3.7e15,    unlockCount: 150, purchased: false },
                    'oil-1':       { id: 'oil-1',       target: 'oil',       effect: 'profit', multiplier: 3, cost: 31e12,     unlockCount: 25,  purchased: false },
                    'oil-2':       { id: 'oil-2',       target: 'oil',       effect: 'profit', multiplier: 4, cost: 3.8e15,    unlockCount: 75,  purchased: false },
                    'oil-3':       { id: 'oil-3',       target: 'oil',       effect: 'speed',  multiplier: 2, cost: 45e15,     unlockCount: 150, purchased: false },
                }
            };
        }

        // --- DATA LOADING & SAVING ---
        function loadGame() {
            const defaultState = getDefaultGameState();
            let data = null;
            try {
                const savedData = localStorage.getItem(SAVE_KEY);
                if (savedData) data = JSON.parse(savedData);
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                data = null; 
            }

            if (data) {
                game = { ...defaultState, ...data };
                game.businesses = defaultState.businesses.map(defaultBiz => {
                    const savedBiz = data.businesses?.find(b => b.id === defaultBiz.id);
                    return savedBiz ? { ...defaultBiz, ...savedBiz } : defaultBiz;
                });
                // Merge saved upgrades with default to ensure new ones are added
                game.upgrades = { ...defaultState.upgrades, ...data.upgrades };
            } else {
                game = defaultState;
            }

            game.businesses.forEach(biz => {
                biz.uiCache = {}; 
            });
            
            calculateOfflineProgress();
            isGameLoaded = true;
            ui.loadingOverlay.classList.add('hidden');
            
            buildBusinessesUI();
            // No need to build upgrades UI here as it's static HTML
            
            requestAnimationFrame(gameLoop);
            setInterval(saveGame, 5000);
        }

        function saveGame() {
            if (isSaving) return;
            isSaving = true;
            try {
                game.lastUpdateTime = new Date().getTime();
                localStorage.setItem(SAVE_KEY, JSON.stringify(game));
            } catch (error) {
                console.error("Error saving game to localStorage:", error);
            }
            isSaving = false;
        }

        // --- GAME LOOP & CORE LOGIC ---
        function gameLoop() {
            if (!isGameLoaded) {
                requestAnimationFrame(gameLoop);
                return;
            }

            const currentTime = new Date().getTime();
            const deltaTime = (currentTime - game.lastUpdateTime) / 1000;

            processAutomation(deltaTime);
            updateUI(currentTime);

            if (currentTime - lastTimerUpdateTime > 1000) {
                updateLongTimers();
                lastTimerUpdateTime = currentTime;
            }

            game.lastUpdateTime = currentTime;
            requestAnimationFrame(gameLoop);
        }

        function calculateOfflineProgress() {
            const currentTime = new Date().getTime();
            const deltaTime = (currentTime - game.lastUpdateTime) / 1000;
            if (deltaTime > 0) processAutomation(deltaTime, true);
        }

        function processAutomation(deltaTime, isOffline = false) {
            let totalRevenue = 0;
            for (const biz of game.businesses) {
                if (biz.hasManager && biz.count > 0) {
                    const effectiveTime = biz.baseTime / getSpeedBonus(biz);
                    if (isOffline) {
                        const cycles = Math.floor(deltaTime / effectiveTime);
                        if (cycles > 0) totalRevenue += cycles * getRevenuePerCycle(biz);
                    } else {
                        biz.automationProgress += deltaTime;
                        if (biz.automationProgress >= effectiveTime) {
                            const cycles = Math.floor(biz.automationProgress / effectiveTime);
                            biz.automationProgress %= effectiveTime;
                            totalRevenue += cycles * getRevenuePerCycle(biz);
                        }
                    }
                }
            }
            if (totalRevenue > 0) {
                game.cash += totalRevenue;
                game.lifetimeCash += totalRevenue;
            }
        }

        // --- CALCULATION FUNCTIONS ---
        function getAngelBonus() { return 1 + (game.angels * 0.02); }
        function getRevenuePerCycle(biz) {
            if (biz.count === 0) return 0;
            let base = biz.baseRevenue * biz.count;
            let upgradeMultiplier = 1;
            for (const upgradeId in game.upgrades) {
                const upg = game.upgrades[upgradeId];
                if (upg.purchased && upg.effect === 'profit' && (upg.target === biz.id || upg.target === 'all')) {
                    upgradeMultiplier *= upg.multiplier;
                }
            }
            return base * upgradeMultiplier * getAngelBonus();
        }
        function getClickRevenue(biz) {
             if (biz.id === 'lemonade' && biz.count === 0) return biz.baseRevenue;
             if (biz.count === 0) return 0;
             return getRevenuePerCycle(biz) / biz.count;
        }
        function getSpeedBonus(biz) {
            const milestones = [25, 50, 100, 200, 300, 400];
            let milestoneMultiplier = 1;
            for (const ms of milestones) {
                if (biz.count >= ms) milestoneMultiplier *= 2;
            }

            let upgradeMultiplier = 1;
            for (const upgradeId in game.upgrades) {
                const upg = game.upgrades[upgradeId];
                if (upg.purchased && upg.effect === 'speed' && upg.target === biz.id) {
                    upgradeMultiplier *= upg.multiplier;
                }
            }
            return milestoneMultiplier * upgradeMultiplier;
        }
        function getNextMilestone(count) {
            const milestones = [25, 50, 100, 200, 300, 400];
            for (const ms of milestones) {
                if (count < ms) return ms;
            }
            return null;
        }
        function getBuyCost(biz, amount) {
            const n = biz.count, r = biz.costRate, c = biz.baseCost;
            const cost = c * (Math.pow(r, n) * (Math.pow(r, amount) - 1)) / (r - 1);
            return isFinite(cost) ? cost : Infinity;
        }
        function getMaxBuyAmount(biz) {
            const n = biz.count, r = biz.costRate, c = biz.baseCost, cash = game.cash;
            const val = (cash * (r - 1)) / (c * Math.pow(r, n)) + 1;
            if (val <= 1) return 0;
            const amount = Math.floor(Math.log(val) / Math.log(r));
            return Math.max(0, amount);
        }
        function getAngelsToGain() {
            const angels = Math.floor(150 * Math.sqrt(game.lifetimeCash / 1e15));
            return Math.max(0, angels - game.angels);
        }

        // --- FORMATTING HELPERS ---
        function formatAbbreviatedNumber(num) {
            if (Math.abs(num) < 1000) return num.toFixed(2).replace('.', ',');
            const units = ["K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const e = Math.floor(Math.log(Math.abs(num)) / Math.log(1000));
            if (e >= units.length) return num.toExponential(2).replace('+', '');
            const abbreviated = (num / Math.pow(1000, e)).toFixed(2);
            return abbreviated.replace('.', ',') + units[e - 1];
        }
        function formatFullNumber(num) {
            const integerPart = Math.floor(num).toLocaleString('de-DE'); 
            const fractionalPart = (num - Math.floor(num)).toFixed(2).substring(2);
            return `${integerPart},${fractionalPart}`;
        }
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds >= 0) parts.push(`${seconds}s`);
            return parts.join(' ');
        }

        // --- UI BUILDING & UPDATING ---
        function updateElementText(elementId, newText, biz, cacheKey) {
            // Check if the cached value is different from the new value.
            if (biz.uiCache[cacheKey] !== newText) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = newText;
                }
                // Update the cache with the new value.
                biz.uiCache[cacheKey] = newText;
            }
        }

        function buildBusinessesUI() {
            let html = '';
            for (const biz of game.businesses) {
                const isLemonade = biz.id === 'lemonade';
                const showStartPulse = isLemonade && biz.count === 0 && game.cash < biz.baseCost;
                html += `
                    <div id="biz-${biz.id}" class="bg-gray-800 rounded-lg p-3 shadow-lg">
                        <div class="flex flex-wrap gap-2 items-center">
                            <div id="biz-click-${biz.id}" class="relative w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center text-3xl cursor-pointer select-none ${showStartPulse ? 'pulse-startup' : ''}" onclick="manualClick('${biz.id}')">
                                ${getBizEmoji(biz.id)}
                                ${showStartPulse ? '<span class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-bold text-amber-400 whitespace-nowrap bg-gray-900 rounded-full px-2 py-0.5 shadow-lg">CLICK TO EARN $1!</span>' : ''}
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <h3 class="text-lg font-bold text-white">${biz.name}</h3>
                                <div class="text-sm"><span class="text-gray-400">Owned:</span> <span id="biz-count-${biz.id}" class="font-semibold text-white">0</span></div>
                                <div class="text-sm"><span class="text-gray-400">Rev/Cycle:</span> <span id="biz-cycle-rev-${biz.id}" class="font-semibold text-green-400">$0,00</span></div>
                                <div class="text-sm"><span class="text-gray-400">Auto Rev/s:</span> <span id="biz-rev-${biz.id}" class="font-semibold text-green-300">$0,00/s</span></div>
                                <div class="text-sm">
                                    <span class="text-gray-400">Time:</span> 
                                    <span id="biz-time-${biz.id}" class="font-semibold text-white">0,00s</span> 
                                    <span id="biz-countdown-${biz.id}" class="text-xs text-gray-400"></span>
                                    <span id="biz-milestone-${biz.id}" class="text-xs text-amber-400 ml-1"></span>
                                </div>
                            </div>
                            <div class="w-full md:w-auto">
                                <button id="biz-buy-${biz.id}" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" onclick="buyBusiness('${biz.id}')">
                                    <div>Buy <span id="biz-buy-amt-${biz.id}">1</span></div>
                                    <div id="biz-cost-${biz.id}" class="text-sm">$0,00</div>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div id="biz-progress-${biz.id}" class="progress-bar-inner bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <button id="biz-manager-${biz.id}" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-sm" onclick="buyManager('${biz.id}')">
                                Hire Manager ($${formatAbbreviatedNumber(biz.managerCost)})
                            </button>
                        </div>
                    </div>
                `;
            }
            ui.businessesPanel.innerHTML = html;
        }

        function getBizEmoji(id) {
            const emojis = { lemonade: 'üçã', newspaper: 'üì∞', carwash: 'üöó', pizza: 'üçï', donut: 'üç©', shrimp: 'üç§', hockey: 'üèí', movie: 'üé¨', bank: 'üè¶', oil: 'üõ¢Ô∏è' };
            return emojis[id] || 'üí∞';
        }

        function updateUI(currentTime) {
            if (currentTime - lastCashUpdateTime > 500) {
                ui.cashDisplay.textContent = `$${formatFullNumber(game.cash)}`;
                lastCashUpdateTime = currentTime;
            }
            const angelsText = formatAbbreviatedNumber(game.angels);
            if (globalUiCache.angels !== angelsText) {
                ui.angelsDisplay.textContent = angelsText;
                globalUiCache.angels = angelsText;
            }

            for (const biz of game.businesses) {
                const el_count = document.getElementById(`biz-count-${biz.id}`);
                if (!el_count) continue; 

                const revenuePerCycle = getRevenuePerCycle(biz);
                const effectiveTime = biz.baseTime / getSpeedBonus(biz);
                const revenuePerSecond = biz.count > 0 ? (revenuePerCycle / effectiveTime) : 0;
                
                const amountToBuy = (game.buyAmount === 'MAX') ? getMaxBuyAmount(biz) : game.buyAmount;
                const costToBuy = (amountToBuy > 0) ? getBuyCost(biz, amountToBuy) : getBuyCost(biz, 1);

                const countText = formatAbbreviatedNumber(biz.count);
                updateElementText(`biz-count-${biz.id}`, countText, biz, 'count');

                const cycleRevText = `$${formatAbbreviatedNumber(revenuePerCycle)}`;
                updateElementText(`biz-cycle-rev-${biz.id}`, cycleRevText, biz, 'cycleRev');

                const revPerSecText = `$${formatAbbreviatedNumber(revenuePerSecond)}/s`;
                updateElementText(`biz-rev-${biz.id}`, revPerSecText, biz, 'rev');

                const timeText = `${effectiveTime.toFixed(2).replace('.', ',')}s`;
                updateElementText(`biz-time-${biz.id}`, timeText, biz, 'time');

                const bizCostText = `$${formatAbbreviatedNumber(costToBuy)}`;
                updateElementText(`biz-cost-${biz.id}`, bizCostText, biz, 'cost');

                const nextMilestoneText = getNextMilestone(biz.count);
                const milestoneText = nextMilestoneText ? `(Next x2 at ${nextMilestoneText})` : ''
                updateElementText(`biz-milestone-${biz.id}`, milestoneText, biz, 'milestone');

                const amountToBuyText = (game.buyAmount === 'MAX' && amountToBuy > 0) ? formatAbbreviatedNumber(amountToBuy) : game.buyAmount;
                updateElementText(`biz-buy-amt-${biz.id}`, amountToBuyText, biz, 'buyAmt');

                let progress;
                if (effectiveTime < 1 && biz.count > 0 && biz.hasManager) {
                    progress = 100;
                } else {
                    progress = (biz.count > 0 && biz.hasManager) ? (biz.automationProgress / effectiveTime) * 100 : 0;
                }
                document.getElementById(`biz-progress-${biz.id}`).style.width = `${Math.min(100, progress)}%`;

                document.getElementById(`biz-buy-${biz.id}`).disabled = (game.cash < costToBuy) || (amountToBuy === 0);
                
                const managerBtn = document.getElementById(`biz-manager-${biz.id}`);
                managerBtn.style.display = biz.hasManager ? 'none' : 'block';
                managerBtn.disabled = biz.count === 0 || game.cash < biz.managerCost;
            }

            updateUpgradesPanel();

            const angelsToGain = getAngelsToGain();
            const angelsToGainText = formatAbbreviatedNumber(angelsToGain);
            if (globalUiCache.angelsToGain !== angelsToGainText) {
                ui.angelsToGainDisplay.textContent = angelsToGainText;
                globalUiCache.angelsToGain = angelsToGainText;
            }

            const angelBoostText = `${(getAngelBonus() * 100 - 100).toFixed(0)}%`;
            if (globalUiCache.angelBoost !== angelBoostText) {
                ui.angelBoostDisplay.textContent = angelBoostText;
                globalUiCache.angelBoost = angelBoostText;
            }

            ui.prestigeButton.disabled = angelsToGain <= 0;
        }

        function updateUpgradesPanel() {
            for (const upgradeId in game.upgrades) {
                const upg = game.upgrades[upgradeId];
                const button = document.getElementById(`upg-btn-${upgradeId}`);
                if (!button) continue;

                const targetBiz = game.businesses.find(b => b.id === upg.target);

                // 1. Determine what the button's state SHOULD be from the game data.
                let desiredState;
                if (upg.purchased) {
                    desiredState = 'purchased';
                } else if (targetBiz && targetBiz.count >= upg.unlockCount) {
                    desiredState = 'unlocked';
                } else {
                    desiredState = 'locked';
                }

                // 2. Get the button's CURRENT state by checking its classList.
                let currentState;
                if (button.classList.contains('purchased')) {
                    currentState = 'purchased';
                } else if (button.classList.contains('unlocked')) {
                    currentState = 'unlocked';
                } else {
                    currentState = 'locked';
                }

                // 3. If the state is already correct, only do a cheap check for affordability.
                if (currentState === desiredState) {
                    // This is the only check needed for a button that is already 'unlocked'.
                    if (desiredState === 'unlocked') {
                        button.disabled = game.cash < upg.cost;
                    }
                    continue; // The appearance is correct, so skip all expensive DOM changes.
                }

                // 4. If the state HAS changed, then update the classes.
                button.classList.remove('locked', 'unlocked', 'purchased');
                button.classList.add(desiredState);

                // And finally, set the disabled state based on the new state.
                if (desiredState === 'unlocked') {
                    button.disabled = game.cash < upg.cost;
                } else {
                    button.disabled = true;
                }
            }
        }

        function updateLongTimers() {
            for (const biz of game.businesses) {
                const countdownEl = document.getElementById(`biz-countdown-${biz.id}`);
                if (!countdownEl) continue;

                const effectiveTime = biz.baseTime / getSpeedBonus(biz);
                if (biz.hasManager && biz.count > 0 && effectiveTime > 60) {
                    const timeLeft = effectiveTime - biz.automationProgress;
                    countdownEl.textContent = `(${formatTime(timeLeft)} left)`;
                } else {
                    countdownEl.textContent = '';
                }
            }
        }

        // --- EVENT HANDLERS ---
        function manualClick(bizId) {
            const biz = game.businesses.find(b => b.id === bizId);
            if (!biz) return;
            const revenue = getClickRevenue(biz);
            if (revenue > 0) {
                game.cash += revenue;
                game.lifetimeCash += revenue;
                ui.cashDisplay.textContent = `$${formatFullNumber(game.cash)}`;
                lastCashUpdateTime = new Date().getTime();
            }
        }

        function buyBusiness(bizId) {
            const biz = game.businesses.find(b => b.id === bizId);
            const amountToBuy = (game.buyAmount === 'MAX') ? getMaxBuyAmount(biz) : game.buyAmount;
            if (amountToBuy === 0) return;
            const cost = getBuyCost(biz, amountToBuy);
            if (game.cash >= cost) {
                game.cash -= cost;
                biz.count += amountToBuy;
                ui.cashDisplay.textContent = `$${formatFullNumber(game.cash)}`;
                lastCashUpdateTime = new Date().getTime();
                lastTimerUpdateTime = 0;
            }
        }

        function buyManager(bizId) {
            const biz = game.businesses.find(b => b.id === bizId);
            if (!biz.hasManager && game.cash >= biz.managerCost && biz.count > 0) {
                game.cash -= biz.managerCost;
                biz.hasManager = true;
                ui.cashDisplay.textContent = `$${formatFullNumber(game.cash)}`;
                lastCashUpdateTime = new Date().getTime();
            }
        }
        
        function buyUpgrade(upgradeId) {
            const upg = game.upgrades[upgradeId];
            if (!upg || upg.purchased) return;
            const targetBiz = game.businesses.find(b => b.id === upg.target);
            const isUnlocked = targetBiz && targetBiz.count >= upg.unlockCount;
            if (isUnlocked && game.cash >= upg.cost) {
                game.cash -= upg.cost;
                upg.purchased = true;
                ui.cashDisplay.textContent = `$${formatFullNumber(game.cash)}`;
                lastCashUpdateTime = new Date().getTime();
                lastTimerUpdateTime = 0; // Force timer update if speed changed
                saveGame();
            }
        }

        function prestige() {
            const angelsToGain = getAngelsToGain();
            if (angelsToGain <= 0) return;
            showModal("Confirm Reset", 
                `Are you sure you want to reset? You will gain ${formatAbbreviatedNumber(angelsToGain)} Angel Investors, but all your businesses, cash, and upgrades will be reset.`,
                () => {
                    game.angels += angelsToGain;
                    const defaultState = getDefaultGameState();
                    game.cash = 0;
                    game.businesses = defaultState.businesses;
                    game.upgrades = defaultState.upgrades;
                    saveGame();
                }
            );
        }

        function setBuyAmount(amount, clickedButton) {
            game.buyAmount = amount;
            ui.buyToggleBtns.forEach(btn => {
                btn.classList.remove('active', 'bg-amber-500');
            });
            clickedButton.classList.add('active', 'bg-amber-500');
        }

        function showTab(tabName) {
            ui.tabPanels.forEach(panel => {
                panel.id === `panel-${tabName}` ? panel.classList.remove('hidden') : panel.classList.add('hidden');
            });
            ui.tabBtns.forEach(btn => {
                btn.id === `tab-btn-${tabName}` ? btn.classList.add('active') : btn.classList.remove('active');
            });
        }
        
        function showModal(title, message, onConfirm) {
            const existingModal = document.getElementById('custom-modal');
            if (existingModal) existingModal.remove();
            const modalHTML = `
                <div id="custom-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-6">
                        <h3 class="text-xl font-bold mb-3">${title}</h3>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                            <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('modal-cancel').onclick = () => document.getElementById('custom-modal').remove();
            document.getElementById('modal-confirm').onclick = () => {
                onConfirm();
                document.getElementById('custom-modal').remove();
            };
        }

        // --- START THE GAME ---
        window.onload = loadGame;

    </script>
</body>
</html>